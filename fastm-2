-- âš™ï¸ Auto Fast M1 (Optimized + Safe + Lightweight)
-- Ãp dá»¥ng nguyÃªn táº¯c giáº£m táº£i CPU/RAM

-- Cáº¥u hÃ¬nh
local FIRE_INTERVAL = 0.1  -- khoáº£ng cÃ¡ch giá»¯a má»—i láº§n gá»­i (giÃ¢y)
local schedule = {
    {13, 54},
    {127, 133},
}

-- Quáº£n lÃ½ tráº¡ng thÃ¡i vÃ  cleanup
local M1Manager = {}
M1Manager.active = false
M1Manager.connections = {}
M1Manager.threads = {}
M1Manager.fireCount = 0
M1Manager.startTick = tick()

function M1Manager:Cleanup()
    self.active = false
    for _, t in ipairs(self.threads) do
        pcall(function()
            if coroutine.close then coroutine.close(t) end
        end)
    end
    self.threads = {}
    self.connections = {}
    print("[Auto Fast M1] ğŸ”´ Dá»«ng vÃ  dá»n dáº¹p xong.")
    collectgarbage("collect")
end

-- TÃ¬m remote an toÃ n
local function FindRemote()
    local rs = game:GetService("ReplicatedStorage")
    local remote
    pcall(function()
        local bridge = rs:FindFirstChild("BridgeNet2")
        if bridge then
            remote = bridge:FindFirstChild("dataRemoteEvent")
        end
        if not remote then
            for _, v in ipairs(rs:GetDescendants()) do
                if v.Name == "dataRemoteEvent" then
                    remote = v
                    break
                end
            end
        end
    end)
    return remote
end

-- Táº¡o buffer compat
local bf
if type(buffer) == "table" and type(buffer.fromstring) == "function" then
    bf = buffer.fromstring
else
    bf = function(s) return s end
end

-- HÃ m gá»­i an toÃ n
local function SafeFire(remote, payload)
    if not remote then return end
    local ok, err = pcall(function()
        remote:FireServer({ { bf(payload) }, "\019" })
    end)
    if ok then
        M1Manager.fireCount += 1
    elseif not SafeFire._warned then
        warn("[Auto Fast M1] âš ï¸ KhÃ´ng gá»­i Ä‘Æ°á»£c:", tostring(err))
        SafeFire._warned = true
    end
end

-- HÃ m chÃ­nh cháº¡y schedule
local function RunSchedule()
    local remote = FindRemote()
    if not remote then
        warn("[Auto Fast M1] âŒ KhÃ´ng tÃ¬m tháº¥y dataRemoteEvent â€” dá»«ng.")
        return
    end

    M1Manager.active = true
    M1Manager.startTick = tick()

    for i, win in ipairs(schedule) do
        local s, e = tonumber(win[1]), tonumber(win[2])
        if not (s and e and e > s) then
            warn(("[Auto Fast M1] âš ï¸ Schedule #%d khÃ´ng há»£p lá»‡ (start=%s, end=%s)"):format(i, tostring(s), tostring(e)))
        else
            local thread = coroutine.create(function()
                local startTime = M1Manager.startTick + s
                local endTime = M1Manager.startTick + e
                local delay = startTime - tick()

                if delay > 0 then task.wait(delay) end
                if tick() >= endTime or not M1Manager.active then return end

                print(("[Auto Fast M1] ğŸŸ¢ #%d ON (%.1fs â†’ %.1fs)"):format(i, s, e))

                while tick() < endTime and M1Manager.active do
                    local t0 = tick()
                    SafeFire(remote, "\019\000\000\0000201000113686372022\000")
                    -- Throttle chÃ­nh xÃ¡c hÆ¡n, bá» qua tick náº¿u frame lag
                    local delta = FIRE_INTERVAL - (tick() - t0)
                    if delta > 0 then task.wait(delta) else task.wait() end
                end

                print(("[Auto Fast M1] ğŸ”´ #%d OFF (%.1fs)"):format(i, e))
            end)

            M1Manager.threads[#M1Manager.threads + 1] = thread
            task.spawn(function()
                coroutine.resume(thread)
            end)
        end
    end
end

-- Dá»«ng táº¥t cáº£ náº¿u Ä‘ang cháº¡y
if M1Manager.active then
    print("[Auto Fast M1] ğŸ” Äang cháº¡y, dá»«ng láº¡i Ä‘á»ƒ khá»Ÿi Ä‘á»™ng má»›i.")
    M1Manager:Cleanup()
    task.wait(0.2)
end

-- Cháº¡y script
RunSchedule()

-- Cho phÃ©p dá»«ng thá»§ cÃ´ng
getgenv().StopFastM1 = function()
    M1Manager:Cleanup()
end

-- ThÃ´ng tin thá»‘ng kÃª
getgenv().FastM1Stats = function()
    print(("[Auto Fast M1] ğŸ§¾ ÄÃ£ gá»­i: %d láº§n | Thá»i gian cháº¡y: %.1fs"):format(
        M1Manager.fireCount, tick() - M1Manager.startTick
    ))
end
