-- âš™ï¸ Auto Shield (Lightweight Optimized v2)
-- Ãp dá»¥ng theo "NguyÃªn táº¯c chung Ä‘á»ƒ khÃ´ng lÃ m náº·ng"

local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ğŸ•’ Schedule cÃ¡c khung thá»i gian báº­t shield
local schedule = {
    {59, 67},
    {83, 91},
    {105, 113},
}

-- ğŸ” TÃ¬m remote (tá»± Ä‘á»™ng fallback)
local remote
pcall(function()
    local bridge = ReplicatedStorage:FindFirstChild("BridgeNet2")
    if bridge then
        remote = bridge:FindFirstChild("dataRemoteEvent")
    end
    if not remote then
        for _, v in ipairs(ReplicatedStorage:GetDescendants()) do
            if v.Name == "dataRemoteEvent" then
                remote = v
                break
            end
        end
    end
end)

-- ğŸ§© HÃ m gá»­i shield an toÃ n
local function safeFireShield(state)
    if not remote then
        if not safeFireShield._warned then
            warn("[Auto Shield] âš ï¸ KhÃ´ng tÃ¬m tháº¥y dataRemoteEvent.")
            safeFireShield._warned = true
        end
        return
    end
    pcall(function()
        remote:FireServer({ state, "\024" })
    end)
end

-- âš™ï¸ Cáº¥u trÃºc quáº£n lÃ½ shield
local ShieldController = {
    tick0 = tick(),
    activeCount = 0,
    running = true,
}

-- ğŸ§¹ Cleanup Ä‘á»ƒ giáº£m RAM/CPU khi dá»«ng
function ShieldController:Stop()
    self.running = false
    safeFireShield(false)
    collectgarbage("collect")
    print("[Auto Shield] ğŸ›‘ Dá»«ng & dá»n dáº¹p hoÃ n táº¥t.")
end

-- ğŸ§  Thread chÃ­nh â€” chá»‰ 1 coroutine duy nháº¥t, khÃ´ng spawn nhiá»u
task.spawn(function()
    print(("[Auto Shield] ğŸŸ¢ Báº¯t Ä‘áº§u (tá»•ng %d lá»‹ch)."):format(#schedule))
    local tick0 = ShieldController.tick0

    for i, win in ipairs(schedule) do
        if not ShieldController.running then break end

        local startT, endT = win[1], win[2]
        if type(startT) ~= "number" or type(endT) ~= "number" or endT <= startT then
            warn(("[Auto Shield] âš ï¸ Schedule #%d khÃ´ng há»£p lá»‡."):format(i))
            continue
        end

        -- ğŸ•“ Chá» tá»›i thá»i Ä‘iá»ƒm báº¯t Ä‘áº§u
        local waitStart = tick0 + startT - tick()
        if waitStart > 0 then task.wait(waitStart) end
        if not ShieldController.running then break end

        -- â© Báº­t shield
        ShieldController.activeCount += 1
        if ShieldController.activeCount == 1 then
            print(("[Auto Shield] #%d Báº¬T (%.1fsâ†’%.1fs)"):format(i, startT, endT))
            safeFireShield(true)
        else
            print(("[Auto Shield] #%d Báº¬T (activeCount=%d)"):format(i, ShieldController.activeCount))
        end

        -- ğŸ•“ Giá»¯ Ä‘áº¿n lÃºc táº¯t
        local duration = tick0 + endT - tick()
        if duration > 0 then task.wait(duration) end
        if not ShieldController.running then break end

        -- â¹ï¸ Giáº£m counter, táº¯t khi háº¿t khung active
        ShieldController.activeCount = math.max(0, ShieldController.activeCount - 1)
        if ShieldController.activeCount == 0 then
            print(("[Auto Shield] #%d Táº®T (%.1fs) â†’ gá»­i false"):format(i, endT))
            safeFireShield(false)
        else
            print(("[Auto Shield] #%d Táº®T (%.1fs) â†’ cÃ²n %d khung active"):format(i, endT, ShieldController.activeCount))
        end
    end

    ShieldController:Stop()
end)

-- ğŸ›‘ Cho phÃ©p dá»«ng thá»§ cÃ´ng
getgenv().StopAutoShield = function()
    ShieldController:Stop()
end
