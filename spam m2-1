-- âš™ï¸ Auto Spam M2 (Lightweight Optimized)
-- Ãp dá»¥ng nguyÃªn táº¯c "KhÃ´ng lÃ m náº·ng" - 1 thread duy nháº¥t, tá»‘i Æ°u CPU & RAM

local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- â±ï¸ Thá»i gian giá»¯a má»—i láº§n gá»­i
local FIRE_INTERVAL = 0.65

-- ðŸ•’ CÃ¡c khung thá»i gian báº­t/táº¯t spam
local schedule = {
    {13, 22},
    {32, 41},
    {51, 54},
    {127, 133},
}

-- ðŸ” TÃ¬m remote: ReplicatedStorage -> BridgeNet2 -> dataRemoteEvent
local remote
pcall(function()
    local rs = ReplicatedStorage
    local bridge = rs:FindFirstChild("BridgeNet2")
    if bridge then
        remote = bridge:FindFirstChild("dataRemoteEvent")
    end
    if not remote then
        for _, v in ipairs(rs:GetDescendants()) do
            if v.Name == "dataRemoteEvent" then
                remote = v
                break
            end
        end
    end
end)

-- ðŸ§© buffer handler (fallback)
local bf = (type(buffer) == "table" and type(buffer.fromstring) == "function")
    and buffer.fromstring
    or function(s) return s end

local payload_str = "\019\000\000\0000201100101186595482\000"

-- ðŸ§  HÃ m gá»­i tÃ­n hiá»‡u an toÃ n
local function safeFire()
    if not remote then
        if not safeFire._warned then
            safeFire._warned = true
            warn("[Auto Spam M2] âš ï¸ KhÃ´ng tÃ¬m tháº¥y remote dataRemoteEvent.")
        end
        return
    end
    pcall(function()
        remote:FireServer({ { bf(payload_str) }, "\019" })
    end)
end

-- âš™ï¸ Controller quáº£n lÃ½ spam
local M2Controller = {
    tick0 = tick(),
    active = false,
    running = true,
}

-- ðŸ§¹ Cleanup
function M2Controller:Stop()
    self.running = false
    self.active = false
    collectgarbage("collect")
    print("[Auto Spam M2] ðŸ›‘ Dá»«ng & dá»n dáº¹p hoÃ n táº¥t.")
end

-- âš™ï¸ Kiá»ƒm tra xem hiá»‡n táº¡i cÃ³ trong khung thá»i gian nÃ o khÃ´ng
local function isActiveAt(timeSec)
    for _, win in ipairs(schedule) do
        if timeSec >= win[1] and timeSec < win[2] then
            return true
        end
    end
    return false
end

-- ðŸ§µ Luá»“ng chÃ­nh (1 thread duy nháº¥t)
task.spawn(function()
    print(("[Auto Spam M2] ðŸŸ¢ Báº¯t Ä‘áº§u (tá»•ng %d khung)."):format(#schedule))
    local tick0 = M2Controller.tick0

    while M2Controller.running do
        local t = tick() - tick0
        local shouldActive = isActiveAt(t)

        -- Chá»‰ báº­t/táº¯t khi cáº§n
        if shouldActive and not M2Controller.active then
            M2Controller.active = true
            print(("[Auto Spam M2] ðŸ”› Báº¬T táº¡i %.2fs"):format(t))
        elseif not shouldActive and M2Controller.active then
            M2Controller.active = false
            print(("[Auto Spam M2] ðŸ”´ Táº®T táº¡i %.2fs"):format(t))
        end

        -- Náº¿u Ä‘ang báº­t thÃ¬ gá»­i tÃ­n hiá»‡u Ä‘á»u Ä‘áº·n
        if M2Controller.active then
            safeFire()
        end

        task.wait(FIRE_INTERVAL)
        -- Dá»«ng sau khi háº¿t toÃ n bá»™ schedule
        if t > (schedule[#schedule][2] + 1) then break end
    end

    M2Controller:Stop()
end)

-- ðŸ›‘ Dá»«ng thá»§ cÃ´ng khi cáº§n
getgenv().StopAutoM2 = function()
    M2Controller:Stop()
end
